// server.js
// Simple backend for Inject: NC flights + several clearly labeled simulated flights.
// No real API calls, all mock data.

import http from "http";
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

// ----- ES module __dirname setup -----
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const PORT = process.env.PORT || 3000;
const indexPath = path.join(__dirname, "index.html");

// ----- Mock + simulated flights -----
function getMockFlights() {
  const now = Date.now();
  const inMinutes = (m) => new Date(now + m * 60 * 1000).toISOString();

  return [
    // Realistic-ish NC flights (mock)
    {
      id: "NC-001",
      airline: "Carolina Air",
      flightNumber: "CA123",
      origin: "Raleigh–Durham Intl (RDU)",
      originCode: "RDU",
      destination: "Charlotte Douglas Intl (CLT)",
      destinationCode: "CLT",
      scheduled: inMinutes(45),
      status: "Scheduled",
      note: "Mock NC flight — demo only."
    },
    {
      id: "NC-002",
      airline: "Piedmont Regional",
      flightNumber: "PR204",
      origin: "Piedmont Triad Intl (GSO)",
      originCode: "GSO",
      destination: "Charlotte Douglas Intl (CLT)",
      destinationCode: "CLT",
      scheduled: inMinutes(75),
      status: "Boarding",
      note: "Mock NC flight — demo only."
    },
    {
      id: "NC-003",
      airline: "Blue Ridge Air",
      flightNumber: "BR781",
      origin: "Wilmington Intl (ILM)",
      originCode: "ILM",
      destination: "Charlotte Douglas Intl (CLT)",
      destinationCode: "CLT",
      scheduled: inMinutes(120),
      status: "En Route",
      note: "Mock NC flight — demo only."
    },
    {
      id: "NC-004",
      airline: "Outer Banks Express",
      flightNumber: "OB410",
      origin: "Coastal Carolina Rgnl (EWN)",
      originCode: "EWN",
      destination: "Raleigh–Durham Intl (RDU)",
      destinationCode: "RDU",
      scheduled: inMinutes(25),
      status: "Delayed",
      note: "Weather delay (mock)."
    },

    // ----- Simulated test / sandbox flights (clearly labeled) -----

    // Bluff City (your main simulated airport)
    {
      id: "SIM-BLUFF-001",
      airline: "Bluff City Air (SIMULATED)",
      flightNumber: "BC999",
      origin: "Bluff City Airport (NIH) — SIMULATED — NOT REAL",
      originCode: "NIH",
      destination: "Charlotte Douglas Intl (CLT)",
      destinationCode: "CLT",
      scheduled: inMinutes(90),
      status: "SIMULATED",
      note: "SIMULATED ENTRY — FOR DEMO/TESTING ONLY. NOT REAL FLIGHT DATA."
    },

    // Extra simulated airports so users can choose other fake flights
    {
      id: "SIM-RED-001",
      airline: "Red Valley Test Air (SIMULATED)",
      flightNumber: "RV401",
      origin: "Red Valley Test Field (RVT) — SIMULATED — NOT REAL",
      originCode: "RVT",
      destination: "Raleigh–Durham Intl (RDU)",
      destinationCode: "RDU",
      scheduled: inMinutes(30),
      status: "SIMULATED",
      note: "SIMULATED RANGE FLIGHT — used to test Inject visualization."
    },
    {
      id: "SIM-COAST-001",
      airline: "Coastline Sandbox (SIMULATED)",
      flightNumber: "CS220",
      origin: "Cape Harbor Sandbox (CHX) — SIMULATED — NOT REAL",
      originCode: "CHX",
      destination: "Wilmington Intl (ILM)",
      destinationCode: "ILM",
      scheduled: inMinutes(60),
      status: "SIMULATED",
      note: "SIMULATED TRAINING FLIGHT FOR DEMO PURPOSES."
    },
    {
      id: "SIM-NIGHT-001",
      airline: "Night Ops Lab (SIMULATED)",
      flightNumber: "NO777",
      origin: "Night Ops Field (NOF) — SIMULATED — NOT REAL",
      originCode: "NOF",
      destination: "Charlotte Douglas Intl (CLT)",
      destinationCode: "CLT",
      scheduled: inMinutes(10),
      status: "SIMULATED",
      note: "SIMULATED NIGHT OPS — NOT REAL."
    }
  ];
}

// ----- HTTP server -----
const server = http.createServer((req, res) => {
  console.log(`${req.method} ${req.url}`);

  // Serve frontend
  if (req.url === "/" || req.url.startsWith("/index.html")) {
    fs.readFile(indexPath, (err, data) => {
      if (err) {
        res.writeHead(500, { "Content-Type": "text/plain" });
        res.end("Error loading index.html");
        return;
      }
      res.writeHead(200, { "Content-Type": "text/html" });
      res.end(data);
    });
  }

  // Serve mock flights API
  else if (req.url.startsWith("/api/flights")) {
    const flights = getMockFlights();
    res.writeHead(200, { "Content-Type": "application/json" });
    res.end(JSON.stringify({ flights }));
  }

  // Everything else
  else {
    res.writeHead(404, { "Content-Type": "text/plain" });
    res.end("Not Found");
  }
});

// ----- Start server -----
server.listen(PORT, () => {
  console.log(`✅ Mock server running at http://localhost:${PORT}`);
});
